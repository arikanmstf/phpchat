Date.now=function(){return Math.floor((new Date).getTime()/1e3)};var chatAppWebSocket=function(e){var s=this,n=e.parentObj;s.wsUri=e.wsUri,s.chatUserID=e.USERID,s.liveRefreshInterval=e.liveRefreshInterval,s.connect=function(){s.websocket=new ReconnectingWebSocket(s.wsUri,null,{debug:!1,reconnectInterval:e.reConnectInterval}),s.init()},s.init=function(){s.on={open:function(e){s.websocket.onopen=function(n){s.log("onopen()"),s.onlineInterval=setInterval(function(){s.refreshOnlineList()},s.liveRefreshInterval),$(".chat-userlist-inactive").hide(),"function"==typeof e&&e(n)}},message:function(e){s.websocket.onmessage=function(t){s.log("onmessage()");var a=JSON.parse(t.data),i=function(e){switch(s.log("processMessage()"),e.type){case"system":switch(e.message){case"tell_me_your_information":s.sendMyInformation();break;case"msg_read_success":n.msgReadSuccess(e);break;case"msg_delivered":n.addDeliveredMessage(e);break;case"type_started":n.makeTypeStart(e);break;case"type_ended":n.makeTypeEnd(e)}break;case"chat_ready":}};i(a),"function"==typeof e&&e(t)}},error:function(e){s.websocket.onerror=function(n){s.log("onerror()"),"function"==typeof e&&e(n)}},close:function(e){s.websocket.onclose=function(n){s.log("onclose()"),$(".chat-userlist-inactive").show(),clearInterval(s.onlineInterval),"function"==typeof e&&e(n)}}}},s.markMessageRead=function(e){var n={type:"system",message:"mark_message_read",message_id:e.message_id,sendTime:Date.now(),user_id:s.chatUserID};s.websocket.send(JSON.stringify(n))},s.sendMyInformation=function(){var e={type:"system",message:"my_information",user_name:USERNAME,sendTime:Date.now(),user_id:s.chatUserID};s.websocket.send(JSON.stringify(e))},s.refreshOnlineList=function(){var e={type:"system",message:"tell_me_online_users",user_id:s.chatUserID,last_heartbeat:Date.now()};s.websocket.send(JSON.stringify(e))},s.sendTypeStart=function(e){var n={type:"system",message:"type_start",user_id:s.chatUserID,from:e.from,to:e.to};s.websocket.send(JSON.stringify(n))},s.sendTypeEnd=function(e){var n={type:"system",message:"type_end",user_id:s.chatUserID,from:e.from,to:e.to};s.websocket.send(JSON.stringify(n))},s.connect(),s.log=function(e){}},chatAppChatWindow=function(e){var n=this,t=e.messageBox,a=e.sendBtn,i=e.inputBtn,o=(e.unInput,e.messageBoxLoading),r=e.parentObj;return n.openedMessageNum=e.openedMessageNum,n.maximumMessageNo=e.maximumMessageNo,n.msgJSON=[],n.directMessageID=e.directMessageID,n.chatUserID=e.USERID,n.windowID=e.windowID,n.directMessageID?(n.getMessage=function(e){n.msgJSON.push(e),n.msgJSON=n.msgJSON.splice(n.msgJSON.length-n.maximumMessageNo,n.maximumMessageNo),n.updateMessages(),r.ws.markMessageRead(e),r.checkDeliveredMessages(),$(t).scrollTop($(t).prop("scrollHeight"))},n.updateMessages=function(){var e="",a=function(e){var s=Date.now()-e,n="";return n=60>s?"Just Now":3600>s?Math.floor(s/60)+" mins":86400>s?Math.floor(s/3600)+" hours":604800>s?Math.floor(s/86400)+" days":"old"},i=10;s=0,n.msgJSON.length<=i||(s=i);for(var o=0;o<n.msgJSON.length;o++){var d=n.msgJSON[o],c=d.content.replace(/<([^ ])>|<([^ ])/gi,""),l=d.user_name,g=a(d.sendTime);if(r.isSent(d.from)){var p=d.is_delivered?" delivered":"";e+='<div data-msgsta="sent" data-msgid="'+d.message_id+'" class="row msg_container base_sent"><div class="col-md-10 col-xs-10"><div class="messages msg_sent"><p>'+c+'</p><span class="msg_deliver glyphicon glyphicon-ok '+p+'"></span><time datetime="2009-11-13T20:00">'+l+" • "+g+'</time> </div></div><div class="col-md-2 col-xs-2 avatar"><img src="./img/profile_male.png" class=" img-responsive "></div></div>'}else e+='<div data-msgsta="received" data-msgid="'+d.message_id+'"  class="row msg_container base_receive"><div class="col-md-2 col-xs-2 avatar"><img src="./img/profile_male.png" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive"><p>'+c+'</p><time datetime="2009-11-13T20:00">'+l+" • "+g+"</time></div></div></div> "}e+='<div class="user-typing" id="userTyping_'+n.windowID+'"><span>Typing...</span></div> ',$(t).html(e),n.hideVeryOldMessages()},n.sendMessage=function(){var e=$(i).val();if(""==USERNAME)return void alert("Enter your Name please!");if(""==e)return void alert("Enter Some message Please!");var s={message_id:"",from:n.chatUserID,to:n.directMessageID,is_read:!1,is_delivered:!1,sendTime:Date.now(),windowID:n.windowID,content:e,user_name:USERNAME,type:"chat"};r.sendMessage(s),$(i).val("")},n.hideVeryOldMessages=function(e){e="undefined"==typeof e?n.openedMessageNum:n.openedMessageNum+=e,$(o).show();for(var s=$(t).find(".msg_container"),a=0;a<s.length-1;a++)$(s[a]).show();if(s.length>e){if(!$("#chatShowMore_"+n.windowID).length>0){var i='<div class="chat-show-more" id="chatShowMore_'+n.windowID+'"><span>Show more</span></div>';$(t).prepend(i),$("#chatShowMore_"+n.windowID).click(function(e){n.hideVeryOldMessages(10)})}for(var a=0;a<s.length-e;a++)$(s[a]).hide()}else $("#chatShowMore_"+n.windowID).remove();$(o).hide()},n.showTyping=function(){$("#userTyping_"+n.windowID).css("visibility","visible")},n.hideTyping=function(){$("#userTyping_"+n.windowID).css("visibility","hidden")},$(a).click(function(){n.sendMessage()}),$(i).keyup(function(e){13==e.keyCode?$(a).trigger("click"):27==e.keyCode&&$(this).parent().parent().parent().find(".icon_close").trigger("click")}),$(i).typing({start:function(e,s){r.ws.sendTypeStart({from:n.chatUserID,to:n.directMessageID})},stop:function(e,s){r.ws.sendTypeEnd({from:n.chatUserID,to:n.directMessageID})},delay:1e3}),$("#chat_window_"+n.windowID).bind("keydown",function(e){13==e.keyCode?$(a).trigger("click"):27==e.keyCode&&$(this).find(".icon_close").trigger("click")}),void(n.log=function(e){console.log(e)})):!1},chatAppController=function(e){function s(){var e=parseInt(1e5*Math.random());return t.indexOf(e)>0?s():(t.push(e),e)}var n=this;if(n.documentTitle=document.title,n.titleBlinkInterval=!1,"undefined"==typeof e.reConnectInterval&&(e.reConnectInterval=3e3),"undefined"==typeof e.liveRefreshInterval&&(e.liveRefreshInterval=1e3),"undefined"==typeof e.openedMessageNum?n.openedMessageNum=10:n.openedMessageNum=e.openedMessageNum,"undefined"==typeof e.maximumMessageNo?n.maximumMessageNo=40:n.maximumMessageNo=e.maximumMessageNo,"undefined"==typeof e.USERID)throw new Error("you must specify a USERID to start chatAppController.");if("undefined"==typeof e.wsUri)throw new Error("you must specify a wsUri to start chatAppController.");var e={wsUri:e.wsUri,USERID:e.USERID,parentObj:n,liveRefreshInterval:e.liveRefreshInterval,reConnectInterval:e.reConnectInterval};n.chatUserID=e.USERID,n.ws=new chatAppWebSocket(e),$(window).on("beforeunload",function(){n.ws.websocket.close()}),$(window).unload(function(){n.ws.websocket.close()}),n.ws.on.open(function(){}),n.ws.on.message(function(e){var s=JSON.parse(e.data),t=function(e){switch(e.type){case"private_chat":if(e.is_read||n.addUnReadMessage(e),n.isSent(e.from))for(var s=0;s<n.chatWindows.length;s++)n.chatWindows[s].windowID==e.windowID&&n.chatWindows[s].getMessage(e);else for(var t=!1,s=0;s<n.chatWindows.length;s++)n.chatWindows[s].directMessageID==e.from&&(t=!0,n.chatWindows[s].getMessage(e));n.addOldMessages(e)}};n.updateOnlineList(s.online_users),t(s)}),n.ws.on.error(function(){}),n.ws.on.close(function(){}),n.chatWindows=[],n.oldMessages=[],n.createChatWindow=function(e){var s=new chatAppChatWindow(e);return n.heightFix(),n.chatWindows.push(s),n.getOldMessages(s),{success:function(e){e()}}},n.addOldMessages=function(e){n.oldMessages.push(e)},n.getOldMessages=function(e){for(var s=0;s<n.oldMessages.length;s++)(n.oldMessages[s].from==e.directMessageID||n.oldMessages[s].to==e.directMessageID)&&(e.getMessage(n.oldMessages[s]),n.ws.markMessageRead(n.oldMessages[s]))},n.msgReadSuccess=function(e){for(var s=[],t=0;t<n.unreadMessages.length;t++)n.unreadMessages[t].message_id!=e.message_id&&s.push(n.unreadMessages[t]);n.unreadMessages=s,n.checkUnReadMessages()},n.unreadMessages=[],n.addUnReadMessage=function(e){n.unreadMessages.push(e),n.checkUnReadMessages()},n.checkUnReadMessages=function(){var e=n.unreadMessages;$(".chat-user").each(function(){$(this).find("div.chat-user-list-image-container").attr("data-messages",0);for(var s=0,t=0;t<e.length;t++)$(this).attr("data-id")==e[t].from&&s++;n.addMessageNotification($(this).find("div.chat-user-list-image-container"),s)}),n.unreadMessages.length>0?n.titleBlinkInterval||(n.titleBlinkInterval=setInterval(function(){document.title==n.documentTitle?document.title="You have new messages.":document.title=n.documentTitle},1e3)):(document.title=n.documentTitle,clearInterval(n.titleBlinkInterval),n.titleBlinkInterval=!1)},n.addMessageNotification=function(e,s){s>0?e.attr("data-messages",s):e.attr("data-messages","")},n.deliveredMessages=[],n.addDeliveredMessage=function(e){n.deliveredMessages.push(e),n.checkDeliveredMessages()},n.checkDeliveredMessages=function(){$(".base_sent").each(function(){for(var e=$(this),s=0;s<n.deliveredMessages.length;s++)"sent"==e.attr("data-msgsta")&&e.attr("data-msgid")==n.deliveredMessages[s].message_id&&(e.find("span.msg_deliver").addClass("glyphicon"),e.find("span.msg_deliver").addClass("glyphicon-ok"),e.find("span.msg_deliver").addClass("delivered"))})},n.makeTypeStart=function(e){for(var s=0;s<n.chatWindows.length;s++)n.chatWindows[s].directMessageID==e.from&&n.chatWindows[s].showTyping()},n.makeTypeEnd=function(e){for(var s=0;s<n.chatWindows.length;s++)n.chatWindows[s].directMessageID==e.from&&n.chatWindows[s].hideTyping()},n.sendMessage=function(e){n.ws.websocket.send(JSON.stringify(e))},n.updateOnlineList=function(e){if("undefined"==typeof e)return!1;var s=$("li.chat-user");s.each(function(){$(this).removeClass("online"),$(this).addClass("offline")});for(var n=0;n<e.length;n++)s.each(function(){return $(this).attr("data-id")==e[n].user_id?($(this).removeClass("offline"),void $(this).addClass("online")):void 0})};var t=[];$(document).on("click",".panel-heading span.icon_minim",function(e){var s=$(this);s.hasClass("panel-collapsed")?(s.parents(".panel").find(".panel-body").show(),s.removeClass("panel-collapsed"),s.removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down")):(s.parents(".panel").find(".panel-body").hide(),s.addClass("panel-collapsed"),s.removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up")),n.heightFix()}),$(document).on("focus",".panel-footer input.chat_input",function(e){var s=$(this),n=$(this).parent().parent().parent().find(".minim_chat_window");$(n).hasClass("panel-collapsed")&&(s.parents(".panel").find(".panel-body").show(),$(n).removeClass("panel-collapsed"),$(n).removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down"))}),$(document).on("click",".icon_close",function(e){var s=$(this).attr("for");_temp=s.split("_"),windowID=parseInt(_temp[_temp.length-1]);for(var t=0;t<n.chatWindows.length;t++)n.chatWindows[t].windowID==windowID&&n.chatWindows.splice(t,1);$(".chat-user").each(function(){$(this).attr("opened")==windowID&&$(this).attr("opened",!1)});var a=$(this).parent().parent().parent().parent().parent().parent().parent(),i=a.attr("id");a.parent().find(".chat-userlist-container").removeClass("not-show"),$("#"+i).removeClass("full-width"),$("#"+s).remove()}),$(document).on("click",".chat-user",function(e){$(this).hasClass("offline");var t=$(this).parent().parent().attr("for"),a=s(),i=$(this).find("div.chat-user-list-name-container").text(),o=$(this).attr("data-id"),r=$(this).attr("opened");if(r>0)return void $("#inputBtn_"+r).focus();$(".chat-user").each(function(){$(this).attr("opened",!1)}),$(this).attr("opened",a),$(this).parent().parent().addClass("not-show");var d='<div class="row chat-window col-xs-5 col-md-3" id="chat_window_'+a+'" tabindex="1" ><div class="col-xs-12 col-md-12 chat-panel"><div class="panel panel-default" ><div class="panel-heading top-bar"><div class="col-md-8 col-xs-8"><h3 class="panel-title"><span class="glyphicon glyphicon-comment"></span> Chat - '+i+'</h3></div><div class="col-md-4 col-xs-4" style="text-align: right;"><a href="#"><span class="glyphicon glyphicon-chevron-down icon_minim minim_chat_window"></span></a><a href="#"><span class="glyphicon glyphicon-remove icon_close" for="chat_window_'+a+'"></span></a></div></div><div class="chat-loading-messages" id="messageBoxLoading_'+a+'"><center><img src="./img/preloader.gif"></center></div><div class="panel-body msg_container_base" id="messageBox_'+a+'"></div><div class="panel-footer"><div class="input-group"><input id="inputBtn_'+a+'" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." /><input id="unInput_'+a+'" type="hidden" value="'+USERNAME+'" /><span class="input-group-btn"><button class="btn btn-primary btn-sm" id="sendBtn_'+a+'">Send</button></span></div></div></div></div></div>';$("#"+t).append(d),$("#"+t).addClass("full-width"),$("#inputBtn_"+a).focus();var c={USERID:n.chatUserID,messageBox:"#messageBox_"+a,messageBoxLoading:"#messageBoxLoading_"+a,sendBtn:"#sendBtn_"+a,inputBtn:"#inputBtn_"+a,unInput:"#unInput_"+a,directMessageID:o,windowID:a,parentObj:n,openedMessageNum:n.openedMessageNum,maximumMessageNo:n.maximumMessageNo};$(this);n.createChatWindow(c).success(function(){})}),$(document).on("click",".toggle-userlist",function(){var e=$(this).attr("data-target");$(e).toggle()}),n.isSent=function(e){return e==n.chatUserID},n.heightFix=function(){$(".panel.panel-default").each(function(){var e=-$(this).outerHeight();e++,$(this).css("marginTop",e+"px")})},n.log=function(e){console.log(e)}};